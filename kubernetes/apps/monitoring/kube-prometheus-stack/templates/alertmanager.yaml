---
# yamllint disable rule:line-length
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/master-standalone/secret-v1.json
# yamllint enable rule:line-length
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: alertmanager-secret
stringData:
  alertmanager.yaml: |
    global:
      smtp_hello: "<path:kubernetes/data/internal/smtp-relay#INGRESS_DOMAIN>"
      smtp_smarthost: "smtp-relay.networking.svc.cluster.local:25"
      smtp_from: "alertmanager@<path:kubernetes/data/internal/smtp-relay#INGRESS_DOMAIN>"
      smtp_require_tls: false
    inhibit_rules:
      - source_matchers:
          - severity="critical"
        target_matchers:
          - severity=~"warning|info"
        equal:
          - namespace
          - alertname
      - source_matchers:
          - severity="warning"
        target_matchers:
          - severity="info"
        equal:
          - namespace
          - alertname
      - source_matchers:
          - alertname="InfoInhibitor"
        target_matchers:
          - severity="info"
        equal:
          - namespace
    route:
      receiver: email
      group_by:
        - namespace
      continue: false
      routes:
        - receiver: "null"
          matchers:
            - alertname = InfoInhibitor
        - receiver: healthchecks
          matchers:
            - alertname = Watchdog
          repeat_interval: 15m
        - receiver: discord-cilium
          matchers:
            - alertname = CiliumBlockingTrafficUsingPolicies
          repeat_interval: 15m
        - receiver: discord-csp
          matchers:
            - alertname = CSPAlert
          repeat_interval: 15m
        - receiver: discord-kyverno
          matchers:
            - alertname = KyvernoPolicyFailed
          repeat_interval: 15m
      group_wait: 1m
      group_interval: 10m
      repeat_interval: 12h
    receivers:
      - name: "null"
      - name: "email"
        email_configs:
          - to: "homelab@<path:kubernetes/data/internal/smtp-relay#INGRESS_DOMAIN>"
      - name: "discord-cilium"
        discord_configs:
          - webhook_url: "<path:kubernetes/data/internal/kube-prometheus-stack#DISCORD_CILIUM_WEBHOOK>"
      - name: "discord-csp"
        discord_configs:
          - webhook_url: "<path:kubernetes/data/internal/kube-prometheus-stack#DISCORD_CSP_WEBHOOK>"
      - name: "discord-kyverno"
        discord_configs:
          - webhook_url: "<path:kubernetes/data/internal/kube-prometheus-stack#DISCORD_KYVERNO_WEBHOOK>"
      - name: "healthchecks"
        webhook_configs:
          - send_resolved: false
            url: "<path:kubernetes/data/internal/kube-prometheus-stack#EXTERNAL_PING_URL>"
            http_config:
              follow_redirects: true
