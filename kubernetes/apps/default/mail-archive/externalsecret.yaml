---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: mail-archive
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault
  target:
    name: mail-archive-secret
    template:
      data:
        DESTINATION_PASS: "{{ .MAIL_ARCHIVE_IMAPSYNC_DESTINATION_PASS }}"
        DESTINATION_USER: "{{ .MAIL_ARCHIVE_IMAPSYNC_DESTINATION_USER }}"
        DOVECOT_PASSWD: "{{ .MAIL_ARCHIVE_IMAPSYNC_DESTINATION_USER }}:{{ .MAIL_ARCHIVE_IMAPSYNC_DESTINATION_PASS }}:::"
        SOURCE_PASS: "{{ .MAIL_ARCHIVE_IMAPSYNC_SOURCE_PASS }}"
        SOURCE_USER: "{{ .MAIL_ARCHIVE_IMAPSYNC_SOURCE_USER }}"
  dataFrom:
    - extract:
        key: kubernetes
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: mail-archive-configs
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault
  target:
    name: mail-archive-configs-secret
    template:
      data:
        roundcube.oauth.inc.php: |-
          <?php
          $config['use_https'] = true;
          $_SERVER['SERVER_PORT'] = '443';

          $config['oauth_provider'] = 'generic';
          $config['oauth_provider_name'] = 'Pocket ID';
          $config['oauth_client_id'] = '{{ .MAIL_ARCHIVE_ROUNDCUBE_CLIENT_ID }}';
          $config['oauth_client_secret'] = '{{ .MAIL_ARCHIVE_ROUNDCUBE_CLIENT_SECRET }}';
          $config['oauth_auth_uri'] = 'https://id.${ROOT_DOMAIN}/authorize';
          $config['oauth_token_uri'] = 'https://id.${ROOT_DOMAIN}/api/oidc/token';
          $config['oauth_identity_uri'] = 'https://id.${ROOT_DOMAIN}/api/oidc/userinfo';
          $config['oauth_identity_fields'] = ['email'];
          $config['oauth_scope'] = 'email openid profile';

          $config['oauth_login_redirect'] = true;
          ?>
        # yamllint disable rule:line-length
        dovecot.oauth.conf: |-
          tokeninfo_url = https://id.${ROOT_DOMAIN}/api/oidc/userinfo?access_token=
          introspection_mode = post
          introspection_url = https://{{ .MAIL_ARCHIVE_ROUNDCUBE_CLIENT_ID }}:{{ .MAIL_ARCHIVE_ROUNDCUBE_CLIENT_SECRET }}@id.${ROOT_DOMAIN}/api/oidc/introspect
          force_introspection = no
          username_attribute = email
          tls_ca_cert_file = /etc/ssl/certs/ca-certificates.crt
        # yamllint enable rule:line-length
  dataFrom:
    - extract:
        key: kubernetes
