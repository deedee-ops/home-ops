---
# yaml-language-server: $schema=https://schemas.ajgon.casa/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: nas-rules
spec:
  groups:
    - name: nas.rules
      rules:
        - alert: NASCacheUnmounted
          expr: >-
            up{node="nas",job="node-exporter"} == 1
            AND on (node) absent(node_filesystem_mount_info{mountpoint="/mnt/cache", node="nas"})
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: NAS /mnt/cache is not mounted.
        - alert: NASTankUnmounted
          expr: >-
            up{node="nas",job="node-exporter"} == 1
            AND on (node) absent(node_filesystem_mount_info{mountpoint="/mnt/tank", node="nas"})
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: NAS /mnt/tank is not mounted.
        - alert: NASVMsUnmounted
          expr: >-
            up{node="nas",job="node-exporter"} == 1
            AND on (node) absent(node_filesystem_mount_info{mountpoint="/mnt/apps/vms", node="nas"})
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: NAS /mnt/apps/vms is not mounted
---
# yaml-language-server: $schema=https://schemas.ajgon.casa/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: vault-rules
spec:
  groups:
    - name: vault.rules
      rules:
        - alert: VaultSealed
          expr: vault_core_unsealed == 0
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: Vault sealed (instance {{ $labels.instance }})
            description: |-
              Vault instance is sealed on {{ $labels.instance }}
                VALUE = {{ $value }}
                LABELS = {{ $labels }}
        - alert: VaultTooManyPendingTokens
          expr: avg(vault_token_create_count - vault_token_store_count) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Vault too many pending tokens (instance {{ $labels.instance }})
            description: |-
              Too many pending tokens {{ $labels.instance }}: {{ $value | printf "%.2f"}}%
                VALUE = {{ $value }}
                LABELS = {{ $labels }}
