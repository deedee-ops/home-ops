---
# yaml-language-server: $schema=https://deedee-ops.github.io/schemas/kyverno.io/policy_v1.json
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: kubevirt-set-default-storageclass
spec:
  mutateExistingOnPolicyUpdate: true
  rules:
    - name: add-annotation
      match:
        any:
          - resources:
              kinds:
                - StorageClass
              names:
                - ceph-persistent-filesystem
      mutate:
        targets:
          - apiVersion: storage.k8s.io/v1
            kind: StorageClass
            preconditions:
              all:
                - key: "{{request.object.metadata.name}}"
                  operator: Equals
                  value: ceph-persistent-filesystem
        patchesJson6902: |-
          - path: "/metadata/annotation/storageclass.kubevirt.io~1is-default-virt-class"
            op: add
            value: "true"
