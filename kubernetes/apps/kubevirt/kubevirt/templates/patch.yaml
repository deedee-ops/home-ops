---
# yaml-language-server: $schema=https://schemas.rzegocki.dev/kyverno.io/policy_v1.json
apiVersion: kyverno.io/v1
kind: Policy
metadata:
  name: kubevirt
spec:
  mutateExistingOnPolicyUpdate: true
  rules:
    - name: fix-broken-prometheus-rule
      match:
        any:
          - resources:
              kinds:
                - PrometheusRule
              names:
                - prometheus-kubevirt-rules
      mutate:
        targets:
          - apiVersion: monitoring.coreos.com/v1
            kind: PrometheusRule
            preconditions:
              all:
                - key: "{{target.metadata.name}}"
                  operator: Equals
                  value: prometheus-kubevirt-rules
        patchesJson6902: |-
          - op: replace
            path: /spec/groups/0/rules/41/expr
            value: "vector(0) != 0"
