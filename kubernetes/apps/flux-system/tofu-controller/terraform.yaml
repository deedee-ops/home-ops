---
# yaml-language-server: $schema=https://schemas.ajgon.casa/infra.contrib.fluxcd.io/terraform_v1alpha2.json
apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: external
spec:
  approvePlan: auto
  interval: 5m
  path: ./opentofu/
  runnerPodTemplate:
    metadata:
      labels:
        egress.cilium.io/kube-apiserver: "true"
    spec:
      volumeMounts:
        # workaround to have flux working dir writable
        - mountPath: /tmp/flux-system-external
          name: tmp
        - mountPath: /tmp/flux-system-external/vars
          name: vars
      volumes:
        - name: tmp
          emptyDir: {}
        - name: vars
          secret:
            secretName: tofu-vars-secret
  sourceRef:
    kind: GitRepository
    name: flux-system
    namespace: flux-system
  tfVarsFiles:
    - ./vars/external.tfvars
