---
# yaml-language-server: $schema=https://schemas.ajgon.casa/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tofu-controller
spec:
  chartRef:
    kind: OCIRepository
    name: tofu-controller
  interval: 1h
  dependsOn:
    - name: flux-operator
      namespace: flux-system
  postRenderers:
    - kustomize:
        patches:
          - # Properly resolve DNS domains for cilium policies
            patch: |-
              - op: add
                path: /spec/template/metadata/labels/egress.cilium.io~1kube-apiserver
                value: "true"
            target:
              kind: Deployment
              name: tofu-controller
  values:
    concurrency: 8
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 400m
        memory: 64Mi
    caCertValidityDuration: 24h
    certRotationCheckFrequency: 30m
    runner:
      grpc:
        maxMessageSize: 30
