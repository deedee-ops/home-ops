---
app-template:
  defaultPodOptions:
    securityContext:
      fsGroup: 1000  # vmail
      seccompProfile:
        type: RuntimeDefault

  controllers:
    main:
      type: deployment
      annotations:
        reloader.stakater.com/auto: "true"

      containers:
        main:
          image:
            repository: ghcr.io/slusarz/dovecot-fts-flatcurve
            tag: "v1.0.0"
            pullPolicy: IfNotPresent

          probes:
            startup:
              enabled: false
            readiness: &probes
              enabled: true
              custom: true
              spec:
                tcpSocket:
                  port: 143
                initialDelaySeconds: 5
                periodSeconds: 10
                failureThreshold: 3
            liveness: *probes

          resources:
            requests:
              cpu: 10m
              memory: 64Mi
            limits:
              memory: 256Mi
        tika:
          image:
            repository: ghcr.io/deedee-ops/tika
            tag: 2.9.1
            pullPolicy: IfNotPresent
          securityContext: &securityContext
            runAsNonRoot: true
            runAsUser: 65000
            runAsGroup: 65000
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          probes:
            startup: &probes-tika
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /version
                  port: 9998
            readiness: *probes-tika
            liveness: *probes-tika
          resources:
            requests:
              cpu: 50m
              memory: 256Mi
            limits:
              memory: 1Gi

    roundcube:
      type: deployment
      annotations:
        reloader.stakater.com/auto: "true"

      containers:
        main:
          image:
            repository: ghcr.io/deedee-ops/roundcube
            tag: 1.6.6
            pullPolicy: IfNotPresent

          probes:
            startup:
              enabled: false
            readiness: &probes
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /program/resources/blank.webp
                  port: 3000
                initialDelaySeconds: 5
                periodSeconds: 10
                failureThreshold: 3
            liveness: *probes

          securityContext: *securityContext

          resources:
            requests:
              cpu: 10m
              memory: 64Mi
            limits:
              memory: 256Mi
    imapsync:
      type: cronjob
      cronjob:
        schedule: "0 * * * *"  # every hour
        successfulJobsHistory: 1
        failedJobsHistory: 5

      containers:
        main:
          image:
            repository: ghcr.io/deedee-ops/imapsync
            tag: "2.279"
            pullPolicy: IfNotPresent
          command:
            - imapsync
            - --host1
            - "<path:kubernetes/data/internal/mail-archive#SOURCE_HOST>"
            - --user1
            - "<path:kubernetes/data/internal/mail-archive#SOURCE_USER>"
            - --passfile1
            - /secrets/SOURCE_PASS
            - --ssl1
            - --host2
            - mail-archive.workers.svc.cluster.local
            - --user2
            - "<path:kubernetes/data/internal/mail-archive#DESTINATION_USER>"
            - --passfile2
            - /secrets/DESTINATION_PASS
            - --usecache
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            runAsGroup: 65534
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

          probes:
            startup:
              enabled: false
            readiness: &probes
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - pgrep
                    - -f
                    - imapsync
                initialDelaySeconds: 5
                periodSeconds: 10
                failureThreshold: 3
            liveness: *probes

          resources:
            requests:
              cpu: 100m
              memory: 64Mi
            limits:
              memory: 1Gi

  service:
    main:
      controller: main
      ports:
        http:
          enabled: false
        imap:
          enabled: true
          port: 143
    roundcube:
      controller: roundcube
      ports:
        http:
          enabled: true
          port: 3000
  ingress:
    main:
      enabled: false
    roundcube:
      enabled: true
      className: internal
      annotations:
        gethomepage.dev/enabled: "true"
        gethomepage.dev/group: Apps
        gethomepage.dev/name: Mail Archive
        gethomepage.dev/icon: roundcube.png
        gethomepage.dev/description: Searchable mail archive
      hosts:
        - host: "mail.<path:kubernetes/data/internal/base#ROOT_DOMAIN>"
          paths:
            - path: /
              pathType: Prefix
              service:
                name: roundcube
                port: 3000
      tls:
        - hosts:
            - "mail.<path:kubernetes/data/internal/base#ROOT_DOMAIN>"

  persistence:
    cache:
      enabeld: true
      type: persistentVolumeClaim
      storageClass: ceph-ephemeral-block
      size: 10Gi
      accessMode: ReadWriteOnce
      advancedMounts:
        imapsync:
          main:
            - path: "/var/tmp"

    config:
      enabled: true
      type: secret
      name: mail-archive-secret
      readOnly: true
      advancedMounts:
        main:
          main:
            - path: /etc/dovecot/dovecot.conf
              subPath: dovecot.conf
            - path: /etc/dovecot/passwd
              subPath: passwd
        imapsync:
          main:
            - path: /secrets/SOURCE_PASS
              subPath: SOURCE_PASS
            - path: /secrets/DESTINATION_PASS
              subPath: DESTINATION_PASS
    data:
      enabled: true
      type: persistentVolumeClaim
      existingClaim: mail-archive-data
      accessMode: ReadWriteOnce
      advancedMounts:
        main:
          main:
            - path: /srv/mail
        roundcube:
          main:
            - path: /config
              subPath: _roundcube
    tmpdir:
      enabled: true
      type: emptyDir
      medium: Memory
      advancedMounts:
        imapsync:
          main:
            - path: /var/tmp
        roundcube:
          main:
            - path: /app/installer
            - path: /tmp
            - path: /var/tmp
