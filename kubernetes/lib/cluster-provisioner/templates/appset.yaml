---
# yaml-language-server: $schema=https://datreeio.github.io/CRDs-catalog/argoproj.io/applicationset_v1alpha1.json
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: '{{ required "clusterName is required!" .Values.global.clusterName }}'
spec:
  goTemplate: true
  goTemplateOptions:
    - "missingkey=invalid"
  generators:
    - git:
        repoURL: https://github.com/deedee-ops/home-ops.git
        revision: master
        files:
          # {{- range $enabledApp := .Values.global.enabledApps }}
          - path: "kubernetes/apps/{{ $enabledApp }}/app.yaml"
            # {{- end }}
  # {{`
  template:
    metadata:
      name: '{{ .name }}'
      namespace: argocd
    spec:
      destination:
        namespace: '{{ .namespace }}'
        server: https://kubernetes.default.svc
      project: default
  templatePatch: |-
    # `}}
    # {{`{{`}} $clusterValues := `{{ tpl (.Values | toJson) .Values | replace "`" "\\u0060" }}` | fromJson {{`}}`}}
    # {{`
    metadata:
      annotations:
        argocd.argoproj.io/appset: "true"
    {{- if .serverSideApply }}
        argocd.argoproj.io/compare-options: ServerSideDiff=true
    {{- end }}
    {{- range $annotationName, $annotationValue := .annotations }}
        {{ $annotationName }}: {{ $annotationValue }}
    {{- end }}
    spec:
      sources:
        {{- if .repoURL }}
        - repoURL: "{{ .repoURL }}"
          # {{- $baseVersion := .version }}
          # {{- with index $clusterValues .name }}
          targetRevision: "{{ index . "chartVersion" | default $baseVersion }}"
          # {{- else }}
          targetRevision: "{{ $baseVersion }}"
          # {{- end }}
          # {{- with .repoPath }}
          path: "{{ . }}"
          # {{- else }}
          chart: "{{ .chartName | default .name }}"
          # {{- end }}
          helm:
            releaseName: "{{ .name }}"
            values: |
              # {{- $baseValues := .values }}
              # {{- with index $clusterValues .name }}
              {{- toYaml (deepCopy . | mergeOverwrite ($baseValues | default dict)) | nindent 10 }}
              # {{- else }}
              {{- toYaml ($baseValues | default dict) | nindent 10 }}
              # {{- end }}
        {{- end }}
        {{- if .withKustomize }}
        - repoURL: {{ .repoURL | default "https://github.com/deedee-ops/home-ops.git" }}
          targetRevision: {{ .version | default "staging" }}
          path: "{{ .repoPath }}"
          kustomize: {}
        {{- end }}
        - repoURL: https://github.com/deedee-ops/home-ops.git
          path: kubernetes/apps
          targetRevision: master
          directory:
            recurse: true
            include: '{{ .namespace }}/{{ .name }}/templates/*.yaml'
        - repoURL: https://github.com/deedee-ops/home-ops.git
          path: kubernetes/apps
          targetRevision: master
          directory:
            recurse: true
            include: '{{ .namespace }}/{{ .name }}/templates/*.jsonnet'
            jsonnet:
              extVars:
                - name: namespace
                  value: '{{ .namespace }}'
                - name: global
                  code: true
                  value: >
                    {{ (index $clusterValues "global") | toJson }}

      syncPolicy:
        automated:
          prune: true
        {{- if .selfHeal }}
          selfHeal: true
        {{- end }}
        syncOptions:
          - CreateNamespace=true
          {{- if .serverSideApply }}
          - ServerSideApply=true
          {{- end }}
          {{- range $syncOption := .syncOptions }}
          - "{{ $syncOption }}"
          {{- end }}
        {{- with .retries }}
        retry:
          limit: {{ . }}
          backoff:
            duration: 10s
            factor: 1
        {{- end }}
        {{- with .psp }}
        managedNamespaceMetadata:
          labels:
            pod-security.kubernetes.io/enforce: "{{ . }}"
            pod-security.kubernetes.io/audit: "{{ . }}"
            pod-security.kubernetes.io/warn: "{{ . }}"
        {{- end }}
      {{- if .ignoreDifferences }}
      ignoreDifferences:
        {{- .ignoreDifferences | nindent 4 }}
      {{- end }}
    # `}}
