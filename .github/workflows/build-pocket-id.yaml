---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Build pocket-id"

'on':
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # Hourly

jobs:
  build:
    name: Build patched pocket-id
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Fetch latest tag from original repo
        id: source_tag
        run: |
          # Get tags sorted by version (annotated & lightweight
          TAG=$(git ls-remote --tags --sort="v:refname" https://github.com/pocket-id/pocket-id | \
            grep -v '\^{}' | tail -n1 | sed 's/.*\///')
          echo "Latest source tag: $TAG"
          echo "source_tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Get latest package tag
        id: target_tag
        env:
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          PACKAGE="pocket-id"

          # Get latest semver tag
          LATEST_GHCR_TAG=$(curl -s -H "Authorization: Bearer $GHCR_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/${OWNER,,}/packages/container/${PACKAGE,,}/versions" \
            | jq -r '.[0].metadata.container.tags[0]' || echo 'v0.0.0')

          echo "Latest target tag: $LATEST_GHCR_TAG"
          echo "target_tag=$LATEST_GHCR_TAG" >> "$GITHUB_OUTPUT"

      - name: Compare tags
        id: compare
        run: |
          if [ "${SOURCE_TAG}" != "${TARGET_TAG}" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          SOURCE_TAG: ${{ steps.source_tag.outputs.source_tag }}
          TARGET_TAG: ${{ steps.target_tag.outputs.target_tag }}

      - name: Checkout
        if: steps.compare.outputs.changed == 'true'
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          persist-credentials: false
          repository: pocket-id/pocket-id
          ref: ${{ steps.source_tag.outputs.source_tag }}

      - name: Log in to GitHub Container Registry
        if: steps.compare.outputs.changed == 'true'
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Patch OIDC controller for dovecot
        if: steps.compare.outputs.changed == 'true'
        run: >-
          base64 -d <(echo
          "LS0tIGIvYmFja2VuZC9pbnRlcm5hbC9jb250cm9sbGVyL29pZGNfY29udHJvbGxlci5nbwkyMDI1LTExLTI4IDIwOjUwOjU3Ljc1NDkzNDc4OCArMDEwMAorKysgYS9iYWNrZW5kL2ludGVybmFsL2NvbnRyb2xsZXIvb2lkY19jb250cm9sbGVyLmdvCTIwMjUtMTEtMjggMjA6NTE6NDYuNzI5MDgyNzQxICswMTAwCkBAIC0yMDQsOCArMjA0LDExIEBACiBmdW5jIChvYyAqT2lkY0NvbnRyb2xsZXIpIHVzZXJJbmZvSGFuZGxlcihjICpnaW4uQ29udGV4dCkgewogCV8sIGF1dGhUb2tlbiwgb2sgOj0gc3RyaW5ncy5DdXQoYy5HZXRIZWFkZXIoIkF1dGhvcml6YXRpb24iKSwgIiAiKQogCWlmICFvayB8fCBhdXRoVG9rZW4gPT0gIiIgewotCQlfID0gYy5FcnJvcigmY29tbW9uLk1pc3NpbmdBY2Nlc3NUb2tlbnt9KQotCQlyZXR1cm4KKwkJYXV0aFRva2VuLCBvayA9IGMuR2V0UXVlcnkoImFjY2Vzc190b2tlbiIpCisJCWlmICFvayB8fCBhdXRoVG9rZW4gPT0gIiIgeworCQkJXyA9IGMuRXJyb3IoJmNvbW1vbi5NaXNzaW5nQWNjZXNzVG9rZW57fSkKKwkJCXJldHVybgorCQl9CiAJfQogCiAJdG9rZW4sIGVyciA6PSBvYy5qd3RTZXJ2aWNlLlZlcmlmeU9BdXRoQWNjZXNzVG9rZW4oYXV0aFRva2VuKQo=")
          | patch -p1

      - name: Set up Docker Buildx
        if: steps.compare.outputs.changed == 'true'
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Build and push image
        if: steps.compare.outputs.changed == 'true'
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: "ghcr.io/deedee-ops/pocket-id:${{ steps.source_tag.outputs.source_tag }}"
          # yamllint enable rule:comments
