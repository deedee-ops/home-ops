---
# yaml-language-server: $schema=https://schemas.ajgon.casa/other/docker-compose.json
services:
  traefik:
    env_file:
      - ./compose.env
      - ./override.env
      - .env # dynamically created by stacks
    image: public.ecr.aws/docker/library/traefik:3.6.8@sha256:90099f8948c828ecf0ababd711a4359a2443eba12261c1df2f548a3b1d815938
    container_name: traefik
    restart: always
    environment:
      TZ: Europe/Warsaw
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "80:80"
      - "443:443"
    configs:
      - source: traefik-config
        target: /etc/traefik/traefik.yml
    volumes:
      - ./config/extra:/config
      - /var/run/docker.sock:/var/run/docker.sock
      - "${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}/volumes/traefik/certs:/certs"
      - "${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}/volumes/vault/file/cert.pem:/config/vault-internal.pem"
    networks:
      - default
      - internal
    # security
    cap_drop:
      - all
    security_opt:
      - no-new-privileges
    read_only: true
  traefik-to-unifi:
    env_file:
      - ./override.env
    image: ghcr.io/thomaslomas/traefik-to-unifi:v1.3.0@sha256:0aeeeb8171da8268edec8d87d599f129aded778ba98eb5eac1eccc5f10bcbcec
    container_name: traefik-to-unifi
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # security
    cap_drop:
      - all
    security_opt:
      - no-new-privileges
    read_only: true

configs:
  traefik-config:
    file: ./config/traefik.yaml

networks:
  internal:
    name: internal
    external: true
