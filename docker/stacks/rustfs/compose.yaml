---
# yaml-language-server: $schema=https://schemas.ajgon.casa/other/docker-compose.json
services:
  rustfs:
    image: rustfs/rustfs:latest@sha256:b4b638393079ce687546a51a70ecace3070a9cc5f1a4fce65056a6305e30b743
    container_name: rustfs
    user: "1000:1000"
    restart: unless-stopped
    env_file:
      - ./compose.env
      - ./override.env
    volumes:
      - "${S3_DATA_DIRECTORY:-/s3}:/data"
    networks:
      - internal
    # security
    cap_drop:
      - all
    security_opt:
      - no-new-privileges
    # traefik
    labels:
      traefik.enable: "true"
      # S3
      traefik.http.services.s3.loadbalancer.server.port: "9000"
      traefik.http.routers.s3.entrypoints: https
      traefik.http.routers.s3.rule: Host(`s3.${ROOT_DOMAIN}`)
      traefik.http.routers.s3.service: s3
      traefik.http.routers.s3.tls: true
      traefik.http.routers.s3.tls.certresolver: vault-ecdsa
      traefik.http.routers.s3.tls.domains[0].main: 's3.${ROOT_DOMAIN}'
      # Dashboard
      traefik.http.services.rustfs.loadbalancer.server.port: "9001"
      traefik.http.routers.rustfs.entrypoints: https
      traefik.http.routers.rustfs.rule: Host(`rustfs.${ROOT_DOMAIN}`)
      traefik.http.routers.rustfs.service: rustfs
      traefik.http.routers.rustfs.tls: true
      traefik.http.routers.rustfs.tls.certresolver: vault-ecdsa
      traefik.http.routers.rustfs.tls.domains[0].main: 'rustfs.${ROOT_DOMAIN}'
      # Hack for nix-cache to avoid double zstd encoding - without this
      # rustfs will return zstd-compressed response of actual zstd file
      # causing "input compression not recognized" errors on nix
      # Also removes `aws-chunked` content-encoding header, which also causes issues
      traefik.http.routers.s3-nix.entrypoints: https
      traefik.http.routers.s3-nix.rule: >-
        Host(`s3.${ROOT_DOMAIN}`) && PathPrefix(`/nix/nar`) && !HeaderRegexp(`Authorization`, `^AWS4-HMAC-SHA256 .*$`)
      traefik.http.routers.s3-nix.service: s3
      traefik.http.routers.s3-nix.tls: true
      traefik.http.routers.s3-nix.tls.certresolver: vault-ecdsa
      traefik.http.routers.s3-nix.tls.domains[0].main: 's3.${ROOT_DOMAIN}'
      traefik.http.routers.s3-nix.middlewares: nix-encoding
      traefik.http.middlewares.nix-encoding.headers.customresponseheaders.Content-Encoding: ""

networks:
  internal:
    name: internal
    external: true
