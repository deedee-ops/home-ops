---
# yaml-language-server: $schema=https://schemas.ajgon.casa/other/docker-compose.json
services:
  vault:
    image: hashicorp/vault:1.21.3@sha256:5f244d447c6f90107149c9565da5ffedf847cec673ba0062a82fc3dd83c89e65
    container_name: vault
    restart: unless-stopped
    command: server
    configs:
      - source: vault-config
        target: /vault/config/config.hcl
    volumes:
      - "${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}/volumes/vault/file:/vault/file"
      - "./override.env:/secrets/override.env"
      - "/etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt"
    networks:
      - internal
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
    # ports:
    #   - 8200:8200
    # security
    cap_add:
      - CAP_IPC_LOCK
    # traefik
    labels:
      traefik.enable: "true"
      traefik.http.services.vault.loadbalancer.server.port: "8200"
      traefik.http.routers.vault.entrypoints: https
      traefik.http.routers.vault.rule: Host(`vault.${ROOT_DOMAIN}`)
      traefik.http.routers.vault.service: vault
      traefik.http.routers.vault.tls: true
      traefik.http.routers.vault.tls.certresolver: vault-ecdsa
      traefik.http.routers.vault.tls.domains[0].main: "vault.${ROOT_DOMAIN}"
    post_start:
      - command: >-
          sh -c "
          while ! vault operator unseal $(cat /secrets/override.env | sed -E 's@[^=]*=\"?([^\"]+)\"?@\\1@'); do
          sleep 1;
          done"

configs:
  vault-config:
    file: ./config/config.hcl

networks:
  internal:
    name: internal
    external: true
