---
# yaml-language-server: $schema=https://schemas.ajgon.casa/other/docker-compose.json
services:
  registry:
    image: public.ecr.aws/docker/library/registry:3.0.0@sha256:cd92709b4191c5779cd7215ccd695db6c54652e7a62843197e367427efb84d0e
    container_name: registry
    user: "1000:1000"
    restart: unless-stopped
    env_file:
      - registry.env
      - override.env
    networks:
      - internal
    volumes:
      - "/etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt"
    labels:
      traefik.enable: "true"
      traefik.http.services.registry.loadbalancer.server.port: "5000"
      traefik.http.routers.registry.entrypoints: https
      traefik.http.routers.registry.rule: "Host(`registry.${ROOT_DOMAIN}`) && PathPrefix(`/v2`)"
      traefik.http.routers.registry.service: registry
      traefik.http.routers.registry.tls: true
      traefik.http.routers.registry.tls.certresolver: vault-ecdsa
      traefik.http.routers.registry.tls.domains[0].main: 'registry.${ROOT_DOMAIN}'
    # security
    cap_drop:
      - all
    security_opt:
      - no-new-privileges
    read_only: true

  registry-ui:
    image: joxit/docker-registry-ui:2.6.0@sha256:bb5956a6b378706f1c3a92c947d0a0c606e280460cd9e37c0198caf46399c839
    container_name: registry-ui
    user: "101:101" # nginx
    restart: unless-stopped
    env_file:
      - registry-ui.env
    networks:
      - internal
    labels:
      traefik.enable: "true"
      traefik.http.services.registry-ui.loadbalancer.server.port: "8080"
      traefik.http.routers.registry-ui.entrypoints: https
      traefik.http.routers.registry-ui.rule: "Host(`registry.${ROOT_DOMAIN}`) && !PathPrefix(`/v2`)"
      traefik.http.routers.registry-ui.service: registry-ui
      traefik.http.routers.registry-ui.tls: true
      traefik.http.routers.registry-ui.tls.certresolver: vault-ecdsa
      traefik.http.routers.registry-ui.tls.domains[0].main: 'registry.${ROOT_DOMAIN}'
    # security
    cap_drop:
      - all
    security_opt:
      - no-new-privileges

networks:
  internal:
    name: internal
    external: true
