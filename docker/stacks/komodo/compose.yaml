---
# yamllint disable-line rule:line-length
# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
services:
  komodo-ferretdb:
    image: ghcr.io/ferretdb/ferretdb:2.2.0@sha256:9f47e98b9e9fd4e98e778c1e975544e1ca751d2adaf5d79f24f8b3901d8b9c5d
    container_name: komodo
    labels:
      komodo.skip:  # Prevent Komodo from stopping with StopAllContainers
    restart: unless-stopped
    logging:
      driver: local
    volumes:
      - "${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}/volumes/komodo/state:/state"
    environment:
      - FERRETDB_HANDLER=sqlite

  komodo-core:
    image: ghcr.io/moghtech/komodo-core:1.18.0@sha256:b65ee6d2af592841e610aee19951995ac89fd2046db451b77ccbf82506f19f41
    labels:
      komodo.skip:  # Prevent Komodo from stopping with StopAllContainers
      caddy: "*.${ROOT_DOMAIN}"
      caddy.1_@komodo: "host komodo.${ROOT_DOMAIN}"
      caddy.1_handle: "@komodo"
      caddy.1_handle.reverse_proxy: "{{upstreams 9120}}"
    restart: unless-stopped
    depends_on:
      - komodo-ferretdb
    logging:
      driver: local
    env_file:
      - compose.env
    networks:
      - default
      - caddy
    volumes:
      - repo-cache:/repo-cache
      - syncs:/syncs
      - "${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}/volumes/komodo/secrets:/secrets"

networks:
  caddy:
    external: true

volumes:
  repo-cache:
  syncs:
